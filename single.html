<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­—ç¬¦ä¸²ç›¸ä¼¼åº¦æ¯”å¯¹å·¥å…· v2.0 (ä¼˜åŒ–ç‰ˆ)</title>
  <style>
    /* =========================================
       1. å…¨å±€å˜é‡ä¸ä¸»é¢˜é…ç½®
       ========================================= */
    :root {
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #2c3e50;
      --muted: #7f8c8d;
      --border: #e9ecef;
      --primary: #3498db;
      --primary-hover: #2980b9;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #17a2b8;
      --header-shadow: 0 2px 10px rgba(0,0,0,0.05);
      --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
      --radius: 8px;
    }

    body.theme-dark {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #334155;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #06b6d4;
      --header-shadow: 0 2px 10px rgba(0,0,0,0.3);
      --card-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    /* =========================================
       2. åŸºç¡€å¸ƒå±€
       ========================================= */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background: var(--bg);
      font-size: 14px;
      transition: background 0.3s, color 0.3s;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--card-bg); padding: 15px 20px;
      border-radius: var(--radius); box-shadow: var(--header-shadow);
      margin-bottom: 20px;
    }
    header h1 { font-size: 1.5rem; margin-bottom: 4px; }
    header p { color: var(--muted); font-size: 0.9rem; }

    .theme-toggle {
      padding: 6px 12px; border: 1px solid var(--border);
      background: transparent; color: var(--text);
      border-radius: 6px; cursor: pointer; transition: 0.2s;
    }
    .theme-toggle:hover { background: var(--border); }

    /* Grid Layout */
    .main-content {
      display: grid; grid-template-columns: 1fr; gap: 20px;
    }
    @media(min-width: 1200px) {
      .main-content {
        grid-template-columns: 350px 1fr; /* å·¦ä¾§è®¾ç½®ï¼Œå³ä¾§ç»“æœ */
        align-items: start;
      }
      .input-section, .settings-section, .control-section { grid-column: 1; }
      .results-section { grid-column: 2; grid-row: 1 / span 3; }
    }

    section {
      background: var(--card-bg); padding: 20px;
      border-radius: var(--radius); box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }
    section h2 {
      font-size: 1.1rem; margin-bottom: 15px;
      border-bottom: 2px solid var(--primary); display: inline-block;
      padding-bottom: 5px;
    }

    /* =========================================
       3. è¾“å…¥ä¸è®¾ç½®ç»„ä»¶
       ========================================= */
    .input-group { display: flex; flex-direction: column; gap: 15px; }
    .input-column label { display: block; font-weight: 600; margin-bottom: 5px; }
    textarea {
      width: 100%; padding: 10px;
      border: 1px solid var(--border); background: var(--bg); color: var(--text);
      border-radius: 6px; font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px; resize: vertical; outline: none;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: var(--primary); }
    .input-info { font-size: 12px; color: var(--muted); text-align: right; margin-top: 4px; }

    /* Settings */
    .settings-list { display: flex; flex-direction: column; gap: 10px; }
    .checkbox-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .advanced-setting { margin-top: 10px; }
    .advanced-setting label { font-size: 13px; font-weight: 600; display: block; margin-bottom: 5px; }
    
    /* Controls */
    .control-panel { display: flex; flex-direction: column; gap: 15px; }
    .threshold-control { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    input[type=range] { flex: 1; cursor: pointer; }
    #threshold-value { font-weight: bold; color: var(--primary); width: 45px; text-align: right; }

    .progress-container { background: var(--border); height: 16px; border-radius: 8px; overflow: hidden; position: relative; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: width 0.2s; }
    .progress-text { 
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; color: var(--text); font-weight: bold; text-shadow: 0 0 2px var(--bg);
    }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; text-align: center;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--muted); color: white; }

    /* =========================================
       4. ç»“æœå±•ç¤ºåŒº
       ========================================= */
    .results-toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
    .results-wrapper { height: 600px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; position: relative; }
    
    table.result-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { 
      background: var(--card-bg); position: sticky; top: 0; z-index: 10;
      padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
    
    .row-locked { background-color: rgba(39, 174, 96, 0.08); }
    .row-hover:hover { background-color: rgba(52, 152, 219, 0.05); }

    /* Tags & Badges */
    .badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; }
    .sim-high { color: var(--success); background: rgba(39, 174, 96, 0.15); }
    .sim-med { color: var(--warning); background: rgba(243, 156, 18, 0.15); }
    .sim-low { color: var(--danger); background: rgba(231, 76, 60, 0.15); }
    
    /* Diff Styling */
    .diff-add { background: #e6fffa; color: #059669; border-bottom: 1px solid #059669; text-decoration: none; }
    .diff-del { background: #fff5f5; color: #dc2626; text-decoration: line-through; opacity: 0.7; }
    body.theme-dark .diff-add { background: #064e3b; color: #6ee7b7; }
    body.theme-dark .diff-del { background: #450a0a; color: #fca5a5; }

    .match-candidate {
      display: flex; justify-content: space-between; padding: 4px;
      margin-bottom: 4px; border-radius: 4px; cursor: pointer;
      border: 1px solid transparent;
    }
    .match-candidate:hover { border-color: var(--primary); background: rgba(52, 152, 219, 0.1); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #95a5a6; }

    /* Responsive Mobile */
    @media(max-width: 768px) {
      .container { padding: 10px; }
      .main-content { display: flex; flex-direction: column; }
      .btn-group { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>å­—ç¬¦ä¸²ç›¸ä¼¼åº¦æ¯”å¯¹å·¥å…· <span style="font-size:0.6em; opacity:0.7; vertical-align: middle; border:1px solid currentColor; padding:2px 4px; border-radius:4px;">v2.0</span></h1>
        <p>å¿«é€ŸæŸ¥æ‰¾ä¸¤åˆ—æ–‡æœ¬ä¸­çš„ç›¸ä¼¼é¡¹ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ä¸å·®å¼‚é«˜äº®</p>
      </div>
      <button id="theme-btn" class="theme-toggle">ğŸŒ— åˆ‡æ¢ä¸»é¢˜</button>
    </header>

    <div class="main-content">
      
      <!-- å·¦ä¾§æ§åˆ¶åŒº -->
      <div class="sidebar">
        <section class="input-section">
          <h2>1. æ•°æ®è¾“å…¥</h2>
          <div class="input-group">
            <div class="input-column">
              <label>æºæ•°æ®åˆ— (å¾…åŒ¹é…)</label>
              <textarea id="source-input" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;é˜¿é‡Œå·´å·´é›†å›¢&#10;è…¾è®¯ç§‘æŠ€"></textarea>
              <div class="input-info"><span id="source-count">0</span> æ¡</div>
            </div>
            <div class="input-column">
              <label>ç›®æ ‡æ•°æ®åˆ— (å€™é€‰åº“)</label>
              <textarea id="target-input" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;é˜¿é‡Œ&#10;è…¾è®¯&#10;ç™¾åº¦"></textarea>
              <div class="input-info"><span id="target-count">0</span> æ¡</div>
            </div>
          </div>
        </section>

        <section class="settings-section">
          <h2>2. æ¯”å¯¹è®¾ç½®</h2>
          <div class="settings-list">
            <div class="checkbox-item"><label><input type="checkbox" id="opt-punct" checked> å¿½ç•¥æ ‡ç‚¹ç¬¦å·</label></div>
            <div class="checkbox-item"><label><input type="checkbox" id="opt-width" checked> è‡ªåŠ¨å…¨è§’è½¬åŠè§’</label></div>
            <div class="checkbox-item"><label><input type="checkbox" id="opt-space" checked> å¿½ç•¥æ‰€æœ‰ç©ºæ ¼/ä¸å¯è§å­—ç¬¦</label></div>
            
            <div class="advanced-setting">
              <label>åŒä¹‰è¯ç»„ (é€—å·åˆ†éš”ï¼Œæ¯è¡Œä¸€ç»„)</label>
              <textarea id="opt-synonyms" rows="2" placeholder="ä¾‹å¦‚ï¼šé˜¿é‡Œ, é˜¿é‡Œå·´å·´&#10;å¤´æ¡, å­—èŠ‚è·³åŠ¨"></textarea>
            </div>
            <div class="advanced-setting">
              <label>å®Œå…¨å¿½ç•¥è¯ (ä¸å‚ä¸è®¡ç®—)</label>
              <textarea id="opt-ignore" rows="2" placeholder="ä¾‹å¦‚ï¼šæœ‰é™å…¬å¸, è‚¡ä»½, Co., Ltd"></textarea>
            </div>
          </div>
        </section>

        <section class="control-section">
          <h2>3. æ‰§è¡Œæ“ä½œ</h2>
          <div class="control-panel">
            <div class="threshold-control">
              <label>ç›¸ä¼¼åº¦é˜ˆå€¼</label>
              <input type="range" id="threshold-slider" min="0" max="100" value="60">
              <span id="threshold-value">60%</span>
            </div>
            
            <div class="progress-container">
              <div id="progress-bar" class="progress-bar"></div>
              <div id="progress-text" class="progress-text">å‡†å¤‡å°±ç»ª</div>
            </div>

            <div class="btn-group">
              <button id="btn-sample" class="btn btn-secondary">åŠ è½½ç¤ºä¾‹</button>
              <button id="btn-clear" class="btn btn-secondary">æ¸…ç©ºæ•°æ®</button>
            </div>
            <div class="btn-group">
              <button id="btn-start" class="btn btn-primary">å¼€å§‹æ¯”å¯¹</button>
              <button id="btn-stop" class="btn btn-danger" disabled>åœæ­¢</button>
            </div>
          </div>
        </section>
      </div>

      <!-- å³ä¾§ç»“æœåŒº -->
      <section class="results-section">
        <h2>æ¯”å¯¹ç»“æœ</h2>
        <div class="results-toolbar">
          <button id="btn-export-simple" class="btn btn-secondary" style="font-size: 12px;">å¯¼å‡º Excel (ç®€)</button>
          <button id="btn-export-full" class="btn btn-secondary" style="font-size: 12px;">å¯¼å‡º Excel (è¯¦)</button>
          <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
             <label style="font-size:12px"><input type="checkbox" id="view-only-match"> ä»…æ˜¾ç¤ºæœ‰åŒ¹é…é¡¹</label>
          </div>
        </div>
        
        <div id="results-container" class="results-wrapper">
          <div style="padding: 40px; text-align: center; color: var(--muted);">
            åœ¨å·¦ä¾§è¾“å…¥æ•°æ®å¹¶ç‚¹å‡»â€œå¼€å§‹æ¯”å¯¹â€
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    /**
     * ------------------------------------------------------------------
     * æ ¸å¿ƒç®—æ³•ç±»ï¼šè´Ÿè´£å­—ç¬¦ä¸²å¤„ç†ã€ç›¸ä¼¼åº¦è®¡ç®—ã€Diffç”Ÿæˆ
     * ------------------------------------------------------------------
     */
    class AlgorithmCore {
      constructor() {
        this.synonymMap = new Map();
        this.ignoreTerms = [];
        this.fullWidthMap = this._createFullWidthMap();
      }

      // åˆå§‹åŒ–å…¨è§’è½¬åŠè§’æ˜ å°„
      _createFullWidthMap() {
        const map = new Map();
        let i;
        for (i = 0; i < 10; i++) map.set(String.fromCharCode(65296 + i), String(i)); // 0-9
        for (i = 0; i < 26; i++) {
          map.set(String.fromCharCode(65313 + i), String.fromCharCode(65 + i)); // A-Z
          map.set(String.fromCharCode(65345 + i), String.fromCharCode(97 + i)); // a-z
        }
        const symbols = [
          ["ï¼", "!"], ["ï¼‚", "\""], ["ï¼ƒ", "#"], ["ï¼„", "$"], ["ï¼…", "%"], ["ï¼†", "&"],
          ["ï¼‡", "'"], ["ï¼ˆ", "("], ["ï¼‰", ")"], ["ï¼Š", "*"], ["ï¼‹", "+"], ["ï¼Œ", ","],
          ["ï¼", "-"], ["ï¼", "."], ["ï¼", "/"], ["ï¼š", ":"], ["ï¼›", ";"], ["ï¼œ", "<"],
          ["ï¼", "="], ["ï¼", ">"], ["ï¼Ÿ", "?"], ["ï¼ ", "@"], ["ï¼»", "["], ["ï¼¼", "\\"],
          ["ï¼½", "]"], ["ï¼¾", "^"], ["ï¼¿", "_"], ["ï½€", "`"], ["ï½›", "{"], ["ï½œ", "|"],
          ["ï½", "}"], ["ï½", "~"], ["ã€€", " "]
        ];
        symbols.forEach(([full, half]) => map.set(full, half));
        return map;
      }

      updateSettings(synonymStr, ignoreStr) {
        // 1. å¤„ç†åŒä¹‰è¯: "A, B" => Map(A->A, B->A)
        this.synonymMap.clear();
        if (synonymStr) {
          synonymStr.split(/[\n;]+/).forEach(line => {
            const parts = line.split(/[,ï¼Œã€]+/).map(s => s.trim().toLowerCase()).filter(Boolean);
            if (parts.length > 1) {
              const master = parts[0];
              parts.forEach(p => this.synonymMap.set(p, master));
            }
          });
        }

        // 2. å¤„ç†å¿½ç•¥è¯: æŒ‰é•¿åº¦é™åºæ’åˆ—ï¼Œä¼˜å…ˆåŒ¹é…é•¿è¯
        this.ignoreTerms = [];
        if (ignoreStr) {
          this.ignoreTerms = ignoreStr.split(/[\n,ï¼Œã€]+/)
            .map(s => s.trim().toLowerCase())
            .filter(Boolean)
            .sort((a, b) => b.length - a.length);
        }
      }

      // é¢„å¤„ç†æ–‡æœ¬ï¼šè½¬å°å†™ -> å…¨è½¬åŠ -> å»æ ‡ç‚¹ -> å»å¿½ç•¥è¯ -> æ›¿æ¢åŒä¹‰è¯
      normalize(text, options) {
        if (!text) return "";
        let str = String(text);

        // 1. ä¸å¯è§å­—ç¬¦æ¸…é™¤
        if (options.ignoreSpace) str = str.replace(/\s+/g, "");
        
        // 2. å…¨è§’è½¬åŠè§’
        if (options.fullWidth) {
          str = str.split('').map(c => this.fullWidthMap.get(c) || c).join('');
        }

        // è½¬å°å†™
        str = str.toLowerCase();

        // 3. å»é™¤æ ‡ç‚¹ (ä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡)
        if (options.ignorePunct) {
          str = str.replace(/[^\w\u4e00-\u9fa5]/g, "");
        }

        // 4. å»é™¤å¿½ç•¥è¯
        this.ignoreTerms.forEach(term => {
          // ç®€å•æ›¿æ¢ï¼Œéœ€æ³¨æ„æ­£åˆ™è½¬ä¹‰
          if(str.includes(term)) {
            str = str.split(term).join("");
          }
        });

        // 5. åŒä¹‰è¯å½’ä¸€åŒ– (ä»…å½“æ•´ä¸ªä¸²åŒ¹é…åŒä¹‰è¯è¡¨ä¸­æŸé¡¹æ—¶æ›¿æ¢ï¼Œä¹Ÿå¯åšå­ä¸²æ›¿æ¢ï¼Œè¿™é‡Œç®€åŒ–ä¸ºå…¨ä¸²)
        // æ›´é«˜çº§åšæ³•æ˜¯åˆ†è¯åæ›¿æ¢ï¼Œè¿™é‡Œåšç®€å•åŒ…å«æ›¿æ¢
        // ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œç®€åŒ–ï¼šå¦‚æœå®Œå…¨åŒ¹é…åŒä¹‰è¯åº“ä¸­çš„keyï¼Œåˆ™æ›¿æ¢
        if (this.synonymMap.has(str)) {
          str = this.synonymMap.get(str);
        }

        return str;
      }

      // è®¡ç®—ç›¸ä¼¼åº¦ (ç»¼åˆ Levenshtein å’Œ Jaro-Winkler)
      calculateSimilarity(strA, strB) {
        if (strA === strB) return 1.0;
        if (!strA || !strB) return 0.0;

        // ç®€å•çš„ Levenshtein è·ç¦»è½¬åŒ–
        const lenA = strA.length;
        const lenB = strB.length;
        const maxLen = Math.max(lenA, lenB);
        if (maxLen === 0) return 1.0;

        const matrix = [];
        for (let i = 0; i <= lenB; i++) matrix[i] = [i];
        for (let j = 0; j <= lenA; j++) matrix[0][j] = j;

        for (let i = 1; i <= lenB; i++) {
          for (let j = 1; j <= lenA; j++) {
            if (strB.charAt(i - 1) === strA.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1, // æ›¿æ¢
                Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1) // å¢åˆ 
              );
            }
          }
        }
        
        const distance = matrix[lenB][lenA];
        return 1.0 - (distance / maxLen);
      }

      // ç”Ÿæˆ HTML Diff å­—ç¬¦ä¸² (LCS ç®—æ³•)
      generateDiffHtml(source, target) {
        // ç®€å•çš„åŠ¨æ€è§„åˆ’æ±‚ LCS
        const m = source.length, n = target.length;
        const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
        
        for (let i = 1; i <= m; i++) {
          for (let j = 1; j <= n; j++) {
            if (source[i - 1] === target[j - 1]) dp[i][j] = dp[i - 1][j - 1] + 1;
            else dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
          }
        }

        let i = m, j = n;
        let html = "";
        
        // å›æº¯è·¯å¾„
        while (i > 0 || j > 0) {
          if (i > 0 && j > 0 && source[i - 1] === target[j - 1]) {
            html = `<span>${this._escape(source[i - 1])}</span>` + html;
            i--; j--;
          } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
            // Target æœ‰ï¼ŒSource æ²¡æœ‰ -> æ–°å¢
            html = `<span class="diff-add">${this._escape(target[j - 1])}</span>` + html;
            j--;
          } else {
            // Source æœ‰ï¼ŒTarget æ²¡æœ‰ -> åˆ é™¤
            html = `<span class="diff-del">${this._escape(source[i - 1])}</span>` + html;
            i--;
          }
        }
        return html;
      }

      _escape(text) {
        const div = document.createElement('div');
        div.innerText = text;
        return div.innerHTML;
      }
    }

    /**
     * ------------------------------------------------------------------
     * åº”ç”¨æ§åˆ¶å™¨ï¼šè´Ÿè´£ UI äº¤äº’ã€æ•°æ®æµè½¬
     * ------------------------------------------------------------------
     */
    class AppController {
      constructor() {
        this.core = new AlgorithmCore();
        this.isRunning = false;
        this.abortController = null; // ç”¨äºåœæ­¢ä»»åŠ¡
        
        this.sourceData = [];
        this.targetData = []; // { original: string, normalized: string }
        this.results = [];
        this.lockedMap = new Map(); // sourceIndex -> targetObj

        this.dom = {
          sourceInput: document.getElementById('source-input'),
          targetInput: document.getElementById('target-input'),
          sourceCount: document.getElementById('source-count'),
          targetCount: document.getElementById('target-count'),
          
          settings: {
            punct: document.getElementById('opt-punct'),
            width: document.getElementById('opt-width'),
            space: document.getElementById('opt-space'),
            synonyms: document.getElementById('opt-synonyms'),
            ignore: document.getElementById('opt-ignore'),
          },

          slider: document.getElementById('threshold-slider'),
          sliderVal: document.getElementById('threshold-value'),
          
          progressBar: document.getElementById('progress-bar'),
          progressText: document.getElementById('progress-text'),
          
          btnStart: document.getElementById('btn-start'),
          btnStop: document.getElementById('btn-stop'),
          btnSample: document.getElementById('btn-sample'),
          btnClear: document.getElementById('btn-clear'),
          
          resultsContainer: document.getElementById('results-container'),
          exportSimple: document.getElementById('btn-export-simple'),
          exportFull: document.getElementById('btn-export-full'),
          viewOnlyMatch: document.getElementById('view-only-match')
        };

        this.initEvents();
        this.restoreSettings();
      }

      initEvents() {
        // è¾“å…¥ç»Ÿè®¡
        ['input', 'change'].forEach(evt => {
          this.dom.sourceInput.addEventListener(evt, () => this.updateCounts());
          this.dom.targetInput.addEventListener(evt, () => this.updateCounts());
        });

        // é˜ˆå€¼æ»‘å—
        this.dom.slider.addEventListener('input', (e) => {
          this.dom.sliderVal.textContent = e.target.value + '%';
        });

        // æŒ‰é’®äº‹ä»¶
        this.dom.btnSample.addEventListener('click', () => this.loadSample());
        this.dom.btnClear.addEventListener('click', () => this.clearData());
        this.dom.btnStart.addEventListener('click', () => this.startProcess());
        this.dom.btnStop.addEventListener('click', () => this.stopProcess());
        
        // å¯¼å‡º
        this.dom.exportSimple.addEventListener('click', () => this.exportExcel(false));
        this.dom.exportFull.addEventListener('click', () => this.exportExcel(true));
        
        // ç»“æœç­›é€‰
        this.dom.viewOnlyMatch.addEventListener('change', () => this.renderResultsDOM());

        // ä¸»é¢˜åˆ‡æ¢
        document.getElementById('theme-btn').addEventListener('click', () => {
          document.body.classList.toggle('theme-dark');
          localStorage.setItem('sim_theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
        });

        // ç»“æœåŒºå§”æ‰˜äº‹ä»¶ (é”å®š/è§£é”)
        this.dom.resultsContainer.addEventListener('click', (e) => {
          // ç‚¹å‡»é”å®šæŒ‰é’®
          if (e.target.classList.contains('action-lock')) {
            const idx = parseInt(e.target.dataset.idx);
            const matchIdx = parseInt(e.target.dataset.matchIdx);
            this.toggleLock(idx, matchIdx);
          }
          // ç‚¹å‡»å€™é€‰è¯
          if (e.target.closest('.match-candidate')) {
            const el = e.target.closest('.match-candidate');
            const sourceIdx = parseInt(el.dataset.sourceIdx);
            const match = JSON.parse(decodeURIComponent(el.dataset.matchData));
            // ä¸´æ—¶é€‰ä¸­é€»è¾‘ï¼ˆæš‚å®šä¸ºç‚¹å‡»ç›´æ¥é”å®šï¼‰
            this.toggleLock(sourceIdx, null, match);
          }
        });
      }

      updateCounts() {
        const sCount = this.dom.sourceInput.value.split('\n').filter(t => t.trim()).length;
        const tCount = this.dom.targetInput.value.split('\n').filter(t => t.trim()).length;
        this.dom.sourceCount.textContent = sCount;
        this.dom.targetCount.textContent = tCount;
      }

      loadSample() {
        this.dom.sourceInput.value = "é˜¿é‡Œå·´å·´é›†å›¢\nè…¾è®¯ç§‘æŠ€\nç™¾åº¦åœ¨çº¿\nå­—èŠ‚è·³åŠ¨\näº¬ä¸œå•†åŸ\nç½‘æ˜“äº’å¨±";
        this.dom.targetInput.value = "é˜¿é‡Œ\né˜¿é‡Œå·´å·´\nè…¾è®¯\nTencent\nç™¾åº¦\nBaidu\nå­—èŠ‚\nä»Šæ—¥å¤´æ¡\näº¬ä¸œ\nJD.com";
        this.dom.settings.synonyms.value = "é˜¿é‡Œå·´å·´, é˜¿é‡Œ\nè…¾è®¯, Tencent\nç™¾åº¦, Baidu\näº¬ä¸œ, JD";
        this.updateCounts();
      }

      clearData() {
        if(!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) return;
        this.dom.sourceInput.value = "";
        this.dom.targetInput.value = "";
        this.results = [];
        this.lockedMap.clear();
        this.dom.resultsContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted)">æš‚æ— ç»“æœ</div>';
        this.updateCounts();
      }

      // ================= æ ¸å¿ƒå¤„ç†æµç¨‹ =================

      async startProcess() {
        const sourceRaw = this.dom.sourceInput.value.split('\n').filter(x => x.trim());
        const targetRaw = this.dom.targetInput.value.split('\n').filter(x => x.trim());

        if (sourceRaw.length === 0 || targetRaw.length === 0) {
          alert("è¯·ç¡®ä¿æºæ•°æ®å’Œç›®æ ‡æ•°æ®éƒ½ä¸ä¸ºç©º");
          return;
        }

        this.setRunningState(true);
        this.results = [];
        // ä¿ç•™å·²é”å®šçš„ç»“æœï¼ˆå¦‚æœæœ‰æºæ–‡æœ¬å¯¹åº”ï¼‰
        // è¿™é‡Œç®€å•å¤„ç†ï¼šæ¯æ¬¡é‡æ–°å¼€å§‹éƒ½æ¸…ç©ºéé”å®šçš„ç¼“å­˜ï¼Œä½†ä¸ºäº†é€»è¾‘ç®€å•ï¼Œæœ¬æ¬¡å…¨é‡ç®—ï¼Œåç»­å¯ä»¥ä¼˜åŒ–
        
        // 1. è·å–é…ç½®
        const options = {
          ignorePunct: this.dom.settings.punct.checked,
          fullWidth: this.dom.settings.width.checked,
          ignoreSpace: this.dom.settings.space.checked,
        };
        const threshold = parseInt(this.dom.slider.value) / 100;

        // 2. æ›´æ–°æ ¸å¿ƒç®—æ³•é…ç½®
        this.core.updateSettings(this.dom.settings.synonyms.value, this.dom.settings.ignore.value);

        // 3. é¢„å¤„ç†ç›®æ ‡åˆ— (Pre-calculation Optimization)
        //    è¿™ä¸€æ­¥å°† O(N*M) çš„æ­£åˆ™æ“ä½œé™ä½ä¸º O(M)
        this.updateProgress(0, "æ­£åœ¨é¢„å¤„ç†ç›®æ ‡æ•°æ®...");
        await this.waitNextFrame(); // è®©UIæ¸²æŸ“ä¸€ä¸‹

        const processedTargets = targetRaw.map((text, index) => ({
          original: text,
          normalized: this.core.normalize(text, options),
          id: index
        }));

        // 4. åˆ†å—å¤„ç†æºæ•°æ®
        const CHUNK_SIZE = 20; // æ¯æ¬¡å¤„ç†20æ¡ï¼Œé¿å…å¡é¡¿
        let processedCount = 0;
        
        for (let i = 0; i < sourceRaw.length; i += CHUNK_SIZE) {
          if (!this.isRunning) break; // å“åº”åœæ­¢æŒ‰é’®

          const chunk = sourceRaw.slice(i, i + CHUNK_SIZE);
          
          // å¤„ç†è¿™ä¸€å—
          chunk.forEach((sourceText, chunkIndex) => {
            const actualIndex = i + chunkIndex;
            const sourceNorm = this.core.normalize(sourceText, options);
            
            // è®¡ç®—è¯¥æºæ–‡æœ¬ä¸æ‰€æœ‰ç›®æ ‡çš„ç›¸ä¼¼åº¦
            let matches = [];
            
            // éå†ä¼˜åŒ–ï¼šå¦‚æœ sourceNorm ä¸ºç©ºï¼Œè·³è¿‡
            if (sourceNorm) {
              for (const targetObj of processedTargets) {
                if (!targetObj.normalized) continue;
                const sim = this.core.calculateSimilarity(sourceNorm, targetObj.normalized);
                if (sim >= threshold) {
                  matches.push({
                    target: targetObj.original,
                    similarity: sim
                  });
                }
              }
            }

            // æ’åºå–å‰5
            matches.sort((a, b) => b.similarity - a.similarity);
            matches = matches.slice(0, 5);

            // è‡ªåŠ¨é”å®šé€»è¾‘ï¼šå¦‚æœç¬¬ä¸€åæ˜¯ 100%ï¼Œè‡ªåŠ¨é”å®š
            if (matches.length > 0 && matches[0].similarity >= 0.999) {
                if (!this.lockedMap.has(actualIndex)) {
                    this.lockedMap.set(actualIndex, matches[0]);
                }
            }

            this.results[actualIndex] = {
              source: sourceText,
              matches: matches
            };
          });

          processedCount += chunk.length;
          const pct = Math.round((processedCount / sourceRaw.length) * 100);
          this.updateProgress(pct, `æ­£åœ¨æ¯”å¯¹ ${processedCount}/${sourceRaw.length}`);
          
          // è®©å‡ºä¸»çº¿ç¨‹
          await this.waitNextFrame();
        }

        this.setRunningState(false);
        this.updateProgress(100, "æ¯”å¯¹å®Œæˆ");
        this.renderResultsDOM();
      }

      stopProcess() {
        this.isRunning = false;
      }

      waitNextFrame() {
        return new Promise(resolve => setTimeout(resolve, 0));
      }

      setRunningState(state) {
        this.isRunning = state;
        this.dom.btnStart.disabled = state;
        this.dom.btnStop.disabled = !state;
        this.dom.sourceInput.disabled = state;
        this.dom.targetInput.disabled = state;
      }

      updateProgress(percent, text) {
        this.dom.progressBar.style.width = percent + '%';
        this.dom.progressText.textContent = text;
      }

      // ================= ç»“æœæ¸²æŸ“ =================

      renderResultsDOM() {
        const container = this.dom.resultsContainer;
        const viewOnlyMatch = this.dom.viewOnlyMatch.checked;

        if (this.results.length === 0) {
          container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted)">æ— æ•°æ®</div>';
          return;
        }

        let html = `
          <table class="result-table">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th style="width: 30%;">æºæ–‡æœ¬</th>
                <th style="width: 35%;">æœ€ä½³åŒ¹é… (å·®å¼‚å¯¹æ¯”)</th>
                <th style="width: 10%;">ç›¸ä¼¼åº¦</th>
                <th>å…¶ä»–å€™é€‰</th>
              </tr>
            </thead>
            <tbody>
        `;

        this.results.forEach((item, index) => {
          const isLocked = this.lockedMap.has(index);
          const lockedMatch = this.lockedMap.get(index);
          const hasMatches = item.matches.length > 0;

          // ç­›é€‰ï¼šä»…æ˜¾ç¤ºæœ‰åŒ¹é…
          if (viewOnlyMatch && !hasMatches && !isLocked) return;

          // å†³å®šå½“å‰æ˜¾ç¤ºçš„ä¸»åŒ¹é…
          let bestMatch = null;
          if (isLocked) bestMatch = lockedMatch;
          else if (hasMatches) bestMatch = item.matches[0];

          // ç”Ÿæˆ Diff HTML
          let diffHtml = '<span style="color:#ccc">æ— åŒ¹é…</span>';
          let simHtml = '-';
          
          if (bestMatch) {
            diffHtml = this.core.generateDiffHtml(item.source, bestMatch.target);
            simHtml = `<span class="badge ${this.getSimClass(bestMatch.similarity)}">${(bestMatch.similarity * 100).toFixed(0)}%</span>`;
          }

          // ç”Ÿæˆå…¶ä»–å€™é€‰åˆ—è¡¨ (æ’é™¤å½“å‰å±•ç¤ºçš„)
          let candidatesHtml = '';
          if (hasMatches) {
            item.matches.forEach((m, mIdx) => {
              // å¦‚æœå·²ç»é”å®šä¸”æ˜¯å½“å‰é”å®šçš„ï¼Œæˆ–è€…æœªé”å®šä½†å·²ç»æ˜¾ç¤ºåœ¨BestMatchï¼Œè·³è¿‡
              if (bestMatch && m.target === bestMatch.target) return;
              
              const diffShort = this.core.generateDiffHtml(item.source, m.target);
              candidatesHtml += `
                <div class="match-candidate" data-source-idx="${index}" data-match-data="${encodeURIComponent(JSON.stringify(m))}">
                   <div style="font-size:12px;">${diffShort}</div>
                   <div style="font-size:11px;color:var(--muted);text-align:right;">${(m.similarity * 100).toFixed(0)}%</div>
                </div>
              `;
            });
          }

          const rowClass = isLocked ? 'row-locked' : 'row-hover';
          const lockBtnText = isLocked ? 'ğŸ”“ è§£é”' : 'ğŸ”’ é”å®š';
          const lockBtnClass = isLocked ? 'btn-secondary' : 'btn-primary';

          html += `
            <tr class="${rowClass}">
              <td style="color:var(--muted);font-size:12px;">${index + 1}</td>
              <td style="word-break:break-all;">${this.escapeHtml(item.source)}</td>
              <td style="word-break:break-all; line-height:1.6;">${diffHtml}</td>
              <td>${simHtml}</td>
              <td>
                <div style="display:flex;flex-direction:column;gap:4px;">
                   ${ bestMatch ? `<button class="btn action-lock" style="padding:2px 6px;font-size:11px;width:100%" data-idx="${index}" data-match-idx="0">${lockBtnText}</button>` : ''}
                   ${candidatesHtml}
                </div>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      toggleLock(sourceIdx, matchIdx, directMatchObj = null) {
        if (this.lockedMap.has(sourceIdx)) {
          // å·²é”å®š -> è§£é”
          this.lockedMap.delete(sourceIdx);
        } else {
          // æœªé”å®š -> é”å®š
          let match = directMatchObj;
          if (!match && this.results[sourceIdx].matches[0]) {
            match = this.results[sourceIdx].matches[0];
          }
          if (match) {
            this.lockedMap.set(sourceIdx, match);
          }
        }
        this.renderResultsDOM(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°UIçŠ¶æ€
      }

      getSimClass(val) {
        if (val >= 0.9) return 'sim-high';
        if (val >= 0.6) return 'sim-med';
        return 'sim-low';
      }

      escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }

      // ================= å¯¼å‡ºåŠŸèƒ½ =================
      
      exportExcel(isDetailed) {
        if (this.results.length === 0) return alert("æ²¡æœ‰ç»“æœå¯å¯¼å‡º");
        
        let csvContent = "\uFEFF"; // BOM for Excel UTF-8
        
        // Header
        let header = ["æºæ–‡æœ¬", "æœ€ç»ˆåŒ¹é…ç»“æœ", "åŒ¹é…åº¦"];
        if (isDetailed) {
          header.push("å€™é€‰2", "ç›¸ä¼¼åº¦2", "å€™é€‰3", "ç›¸ä¼¼åº¦3");
        }
        csvContent += header.join(",") + "\n";

        // Rows
        this.results.forEach((item, idx) => {
            const locked = this.lockedMap.get(idx);
            let best = locked || item.matches[0];
            
            let row = [];
            row.push(`"${(item.source || '').replace(/"/g, '""')}"`);
            row.push(`"${(best ? best.target : '').replace(/"/g, '""')}"`);
            row.push(best ? (best.similarity * 100).toFixed(2) + '%' : '');

            if (isDetailed) {
                // æ·»åŠ é¢å¤–å€™é€‰
                for(let i=1; i<3; i++) { // æœ€å¤šå†åŠ 2ä¸ª
                    if(item.matches[i]) {
                        row.push(`"${item.matches[i].target.replace(/"/g, '""')}"`);
                        row.push((item.matches[i].similarity * 100).toFixed(2) + '%');
                    } else {
                        row.push("","");
                    }
                }
            }
            csvContent += row.join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "æ¯”å¯¹ç»“æœ.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      restoreSettings() {
        try {
            const theme = localStorage.getItem('sim_theme');
            if(theme === 'dark') document.body.classList.add('theme-dark');
        } catch(e) {}
      }
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      new AppController();
    });
  </script>
</body>
</html>